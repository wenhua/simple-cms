(function() {
  var port, zappa;

  zappa = require('../src/zappa');

  port = 15100;

  this.tests = {
    http: function(t) {
      var c, zapp;
      t.expect(1, 2);
      t.wait(3000);
      zapp = zappa(port++, function() {
        this.helper({
          role: function(name) {
            if (this.request != null) {
              if (this.user.role !== name) return this.redirect('/login');
            }
          }
        });
        return this.get({
          '/': function() {
            this.user = {
              role: 'commoner'
            };
            return this.role('lord');
          }
        });
      });
      c = t.client(zapp.app);
      return c.get('/', function(err, res) {
        t.equal(1, res.statusCode, 302);
        return t.ok(2, res.headers.location.match(/\/login$/));
      });
    },
    multiple: function(t) {
      var c, zapp;
      t.expect(1, 2);
      t.wait(3000);
      zapp = zappa(port++, function() {
        this.helper({
          sum: function(a, b) {
            return a + b;
          }
        });
        this.helper({
          subtract: function(a, b) {
            return a - b;
          }
        });
        return this.get({
          '/': function() {
            t.equal(1, this.sum(1, 2), 3);
            return t.equal(2, this.subtract(1, 2), -1);
          }
        });
      });
      c = t.client(zapp.app);
      return c.get('/');
    }
  };

}).call(this);
